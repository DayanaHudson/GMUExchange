<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link href="stylesheet.css" rel="stylesheet">
    <link href="search.css" rel="stylesheet">
    <link href="compatibility.css" rel="stylesheet">
    <script type = "text/javascript" src = "https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <script type = "text/javascript" src = "myjavascript.js"></script>
    <script src="https://unpkg.com/react@15.3.2/dist/react.js"></script>
    <script src="https://unpkg.com/react-dom@15.3.2/dist/react-dom.js"></script>
    <script src="https://unpkg.com/babel-core@5.8.38/browser.min.js"></script>
</head>
<body>
<script type = "text/babel">
    //starting point: https://facebook.github.io/react/docs/thinking-in-react.html
    var Results = React.createClass({
        render: function() {
            return (
                    <tr>
                        <td>{this.props.image}</td>
                        <td>{this.props.description}</td>
                        <td>{this.props.className}</td>
                        <td>{this.props.professor}</td>
                        <td>${this.props.price}</td>
                        <td>{this.props.category}</td>
                    </tr>
            );
        }
    });

    // onClick functionality: http://stackoverflow.com/questions/33846682/react-onclick-function-fires-on-render
    // removeItem functionality: view-source:https://gmu-swe432.github.io/lecture10demos/public/06bonusreact/
    // <button className = "activeFilterDeselecter" onClick={() => {_this.props.removeItem(this.props.filter)}}>x</button>
    var ActiveFilters = React.createClass({
        render: function() {
            var _this = this;
            return (
                    <td><div className = "activeFilterItem">{this.props.name}: {this.props.value}</div></td>

            );
        }
    });


    var SearchResultsTable = React.createClass({
        render: function() {
            var rows = [];
            var keyword = this.props.filterKeywordText;
            var className = this.props.filterClassText;
            var professor = this.props.filterProfessorText;
            var price = parseFloat(this.props.filterPriceMax);
            //var date = this.props.filterDate;
            this.props.items.forEach(function(item) {
                console.log('id: '+item.id);
                var keywordRegex = new RegExp('');
                var classNameRegex = new RegExp('');
                var professorRegex = new RegExp('');
                if(item.description != null) {
                    keywordRegex = new RegExp('.*');
                }
                if(item.className != null) {
                    classNameRegex = new RegExp('.*');
                }
                if(item.professor != null) {
                    professorRegex = new RegExp('.*');
                }
                var keywordMatch = "";
                var classNameMatch = "";
                var professorMatch = "";
                if(keyword.length > 0 && item.description != null) {
                    keywordRegex = new RegExp('.*' + keyword.toLowerCase() + '.*');
                }
                if(item.description != null){
                    keywordMatch = keywordRegex.exec(item.description.toLowerCase());
                }
                if(className.length > 0 && item.className != null) {
                    classNameRegex = new RegExp('.*' + className.toLowerCase() + '.*');
                }
                if(item.className != null){
                    classNameMatch = classNameRegex.exec(item.className.toLowerCase());
                }
                if(professor.length > 0 && item.professor != null){
                    professorRegex = new RegExp('.*' + professor.toLowerCase() + '.*');
                }
                if(item.professor != null){
                    professorMatch = professorRegex.exec(item.professor.toLowerCase());
                }
                if ((keywordMatch != null && keywordMatch.length > 0) &&
                        (price > parseFloat(item.price) &&
                                ( (item.category == "Miscellaneous" && className == '' && professor == '') ||
                                ((classNameMatch != null && classNameMatch.length > 0) && professorMatch != null))
                        ))
                {
                    rows.push(<Results image = {item.image}
                                       description={item.description}
                                       className={item.className}
                                       professor={item.professor}
                                       price={item.price}
                                       category={item.category}
                                       key={item.id}/>);
                }
            }.bind(this));
            return (
                    <div className = "search" data-list-size="4">
                        <table className = "searchResultTable">
                            <thead>
                            <tr><th>Image</th><th>Description</th><th>Class</th><th>Professor</th><th>Price</th><th>Category</th></tr>
                            </thead>
                            <tbody>{rows}</tbody>
                        </table>
                    </div>
            );
        }
    });

    var SearchBox = React.createClass({
        handleChange: function() {
            this.props.onUserInput(
                    this.refs.filterKeywordTextInput.value,
                    'all',
                    this.refs.filterClassTextInput.value,
                    this.refs.filterProfessorTextInput.value,
                    this.refs.filterPriceMaxInput.value,
                    this.refs.filterDateInput.value,
            );
        },
        /*
        //view-source:https://gmu-swe432.github.io/lecture10demos/public/06bonusreact/
        removeItem: function(filter) {
            console.log('remove: '+filter);
            filter.active = false;
            console.log(filter.active);
            //filtersActive.removeItem(key);
        },*/
        render: function(){
            //var _this = this; //view-source:https://gmu-swe432.github.io/lecture10demos/public/06bonusreact/
            var filtersActive = [];
            var filtersCurrent = [{name: 'Keyword', value: this.props.filterKeywordText, active: true},
                {name: 'Category', value: this.props.filterCategory, active: true},
                {name: 'Class', value: this.props.filterClassText, active: true},
                {name: 'Professor', value: this.props.filterProfessorText, active: true},
                {name: 'Max Price', value: '$'+this.props.filterPriceMax, active: true},
                {name: 'Date', value: this.props.filterDate, active: true}];
            filtersCurrent.forEach( function(filter) {
                if( filter.name == 'Max Price'|| filter.name == 'Category' || (filter.active == true && filter.value!= null && filter.value.length > 0))
                {
                    filtersActive.push(
                            <ActiveFilters key={filter.name}
                                           name={filter.name}
                                           value={filter.value}
                                           active={filter.active}
                            />
                    );
                }
            });
            return (
                    <div className = "search" data-list-size="4">
                        <table className = "searchBoxTable">
                            <tbody>
                            <tr>
                                <td><input
                                        className = "input"
                                        type = "text"
                                        placeholder = "Search by keyword"
                                        value={this.props.filterKeywordText}
                                        ref="filterKeywordTextInput"
                                        onChange={this.handleChange}
                                        id = "searchBox"
                                /></td>
                            </tr>
                            </tbody>
                        </table>
                        <div id = "searchFilters">
                            <table className = "searchBoxTable">
                                <thead>
                                <tr><td>Category</td><td>Class</td><td>Professor</td><td>Maximum Price</td><td>Posted Date</td></tr>
                                </thead>
                                <tbody><tr>
                                    <td><select name="searchTermSelection">
                                        <option name = "category" value="All">All</option>
                                        <option name = "category" value="Textbook">Textbook</option>
                                        <option name = "category" value="Class Notes">Class Notes</option>
                                        <option name = "category" value="Class Materials">Class Materials</option>
                                        <option name = "category" value="Miscellaneous">Miscellaneous</option>
                                    </select></td>
                                    <td><input
                                            className = "input"
                                            type = "text"
                                            placeholder = "Search term"
                                            value={this.props.filterClassText}
                                            ref="filterClassTextInput"
                                            onChange={this.handleChange}
                                            id = "classSearchTermInput"
                                    /></td>
                                    <td><input
                                            className = "input"
                                            type = "text"
                                            placeholder = "Search term"
                                            value={this.props.filterProfessorText}
                                            ref="filterProfessorTextInput"
                                            onChange={this.handleChange}
                                            id = "professorSearchTermInput"
                                    /></td>
                                    <td><input
                                            type="range"
                                            min="0"
                                            max="500"
                                            id="priceSearchTermInput"
                                            value={this.props.filterPriceMax}
                                            ref="filterPriceMaxInput"
                                            onChange={this.handleChange}
                                    /><div id = "maxPriceDisplay">${this.props.filterPriceMax}</div></td>
                                    <td><input
                                            className = "input"
                                            type = "text"
                                            placeholder = "Search term"
                                            value={this.props.filterDate}
                                            ref="filterDateInput"
                                            onChange={this.handleChange}
                                            id = "dateSearchTermInput"/></td>
                                </tr>
                                </tbody>
                            </table>
                            <table>
                                <tbody>
                                <tr>
                                    {filtersActive}
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
            );
        }
    });

    var FilterableSearchTable = React.createClass({
        getInitialState: function() {
            return {
                filterKeywordText: '',
                filterCategory: 'All',
                filterClassText: '',
                filterProfessorText: '',
                filterPriceMax: 500,
                filterDate: ''
            }
        },
        handleUserInput: function(filterKeywordText,filterCategory,filterClassText,filterProfessorText,filterPriceMax,filterDate) {
            this.setState({
                filterKeywordText: filterKeywordText,
                filterCategory: filterCategory,
                filterClassText: filterClassText,
                filterProfessorText: filterProfessorText,
                filterPriceMax: filterPriceMax,
                filterDate: filterDate
            });
        },
        render: function() {
            return (
                    <div>
                        <SearchBox
                                filterKeywordText={this.state.filterKeywordText}
                                filterCategory={this.state.filterCategory}
                                filterClassText={this.state.filterClassText}
                                filterProfessorText={this.state.filterProfessorText}
                                filterPriceMax={this.state.filterPriceMax}
                                filterDate={this.state.filterDate}
                                onUserInput={this.handleUserInput}
                        />
                        <SearchResultsTable
                                items={this.props.items}
                                filterKeywordText={this.state.filterKeywordText}
                                filterCategory={this.state.filterCategory}
                                filterClassText={this.state.filterClassText}
                                filterProfessorText={this.state.filterProfessorText}
                                filterPriceMax={this.state.filterPriceMax}
                                filterDate={this.state.filterDate}
                                onUserInput={this.handleUserInput}
                        />
                    </div>
            );
        }
    });


    var ITEMS = [{id: "1", image: "IMAGE1.jpg", isbn: "978-1305257795", description: "Research Methods and Statistics - 5th edition", price: "144.48", category: "Textbook", className: "GEN 301", professor: "Johnson", date: "01/02/2016"},
        {id: "2", image: "IMAGE2.jpg", isbn: "978-1118345009", description: "Principles of Anatomy and Physiology -Text Only - 14th edition", price: "150.96", category: "Textbook", className: "PHYS 240", professor: "Smith", date: "05/02/2016"},
        {id: "3", image: "IMAGE3.jpg", isbn: "978-1305632134", description: "Power System Analysis and Design - 6th edition", price: "148.49", category: "Textbook", className: "GEN 301", professor: "Marks", date: "07/02/2016"},
        {id: "4", image: "IMAGE4.jpg", isbn: "978-0134201665", description: "Anatomy and Physiology - With Mastering A and P - 6th edition", price: "249.90", category: "Textbook", className: "PHYS 100", professor: "Walker", date: "08/02/2016"},
        {id: "5", image: "IMAGE5.jpg", isbn: null, description: "Class notes for GEN 202", price: "10.00", category: "Class Notes", className: "GEN 301", professor: "Johnson", date: "01/02/2016"},
        {id: "6", image: "IMAGE6.jpg", isbn: null, description: "Class materials for ECE 301", price: "25.00", category: "Class Materials", className: "ECE 301", professor: "Johnson", date: "01/02/2016"},
        {id: "7", image: "IMAGE7.jpg", isbn: null, description: "Desk and chair", price: "40.00", category: "Miscellaneous", className: null, professor: null, date: "05/02/2016"},];


    ReactDOM.render(
            <FilterableSearchTable items={ITEMS} />,
            document.getElementById('container')
    );
</script>
<nav class = "menu">
    <ul>
        <li class = "left" id = "homeLink">Home</li>
        <li class = "left" id = "searchLink">Search</li>
        <li class = "left" id = "postLink">Post Item</li>
        <li class = "rightMenuLinks" id = "logInLink">Log In</li>
        <li class = "rightMenuLinks" id = "signUpLink">Sign Up</li>
        <li id = "logOut">Log Out</li>
        <!--last li element to be defined as username after successful login-->
        <li><span id = "userName"></span></li>
    </ul>
</nav>
<div class = "mainHeading">
    <h1 class = "title">GMUExchange</h1>
    <!--to be defined by home view's JS-->
    <h2 class = "subtitle"></h2>
    <!--Quick log in access-->
    <table class = "quickLogin">
        <tr>
            <th><input class = "input" type = "email" placeholder = "GMU e-mail" id = "quickLoginEmail"/></th>
            <th><input class = "input" type = "password" placeholder = "Password" id = "quickLoginPassword"/></th>
        </tr>
        <tr>
            <td colspan = "2"><button class = "button" id = "quickLoginButton">Log In</button></td>
        </tr>
    </table>
    <!--Image labeled for reuse-->
    <img src="https://upload.wikimedia.org/wikipedia/commons/e/ea/An_aerial_view_of_the_Johnson_Center_at_dawn..jpg">
</div>
<div class = "sectionHeading">
    <h1 class = "title">GMUExchange</h1>
    <!--Subtitle to be defined by each view's JS-->
    <h2 class = "subtitle"  id = "subtitle">Search</h2>
    <!--Image labeled for reuse-->
    <img src="https://upload.wikimedia.org/wikipedia/commons/e/ea/An_aerial_view_of_the_Johnson_Center_at_dawn..jpg">
</div>
<div id="container">
    <!-- This element's contents will be replaced with your component. -->
</div>
</body>
<footer class = "footer">
    <h3>SWE 432</h3>
    <p>Dayana Hudson</p>
    <p>Ermal Dedej</p>
    <p><a href="https://github.com/dayanahudson/GMUExchange/">GitHub</a></p>
</footer>
</html>     